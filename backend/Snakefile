# TODO
import json

with open("./config.json", "r") as fi:
    config = json.load(fi)

STRINGS = [
    "data/processed/{game}/{period}/matchmeta.parquet",
    "outputs/{game}/{period}/{filter}/output.log"
]

STRINGS_EXPANDED = []
GAMES = config.keys()
for game in GAMES:
    FILTERS = config[game]["filters"].keys()
    PERIODS = config[game]["periods"].keys()
    for string in STRINGS:
        STRINGS_EXPANDED += expand(
            string,
            game = GAMES,
            period = PERIODS,
            filter = FILTERS
        )


rule all:
    input:
        STRINGS_EXPANDED


rule db:
    shell: "python3.9 ./analysis/db_update.py"


rule clean:
    shell:
        """
        rm -rf data/processed/*
        rm -rf outputs/*
        """


rule killr:
    shell:
        """
        kill -9 $(ps -u root | awk '$4=="R" {{ printf "%s ", $1 }}')
        """





rule patchmeta:
    output: "data/processed/patchmeta.json"
    input: "analysis/ad_patchmeta.py"
    shell: "python3.9 {input[0]}"


###### Analysis Datasets

rule:
    output:
        "data/processed/{game}/{period}/matchmeta.parquet"
    input:
        "analysis/ad_ana.R",
        "data/processed/patchmeta.json"
    shell:
        "Rscript {input[0]} {wildcards.game} {wildcards.period}"


###### Outputs

rule:
    output:
        "outputs/{game}/{period}/{filter}/output.log"
    input:
        "analysis/outputs.R",
        "data/processed/{game}/{period}/matchmeta.parquet"
    shell:
        "Rscript {input[0]} {wildcards.game} {wildcards.period} {wildcards.filter}"
